/*******************************************************************************
********************************************************************************
**                                                                            **
** ABCC Starter Kit version 3.02.02 (2016-11-10)                              **
**                                                                            **
** Delivered with:                                                            **
**    ABP            7.31.01 (2016-09-16)                                     **
**    ABCC Driver    5.02.01 (2016-11-02)                                     **
**                                                                            */
/*******************************************************************************
********************************************************************************
** COPYRIGHT NOTIFICATION (c) 2015 HMS Industrial Networks AB                 **
**                                                                            **
** This code is the property of HMS Industrial Networks AB.                   **
** The source code may not be reproduced, distributed, or used without        **
** permission. When used together with a product from HMS, permission is      **
** granted to modify, reproduce and distribute the code in binary form        **
** without any restrictions.                                                  **
**                                                                            **
** THE CODE IS PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND. HMS DOES NOT    **
** WARRANT THAT THE FUNCTIONS OF THE CODE WILL MEET YOUR REQUIREMENTS, OR     **
** THAT THE OPERATION OF THE CODE WILL BE UNINTERRUPTED OR ERROR-FREE, OR     **
** THAT DEFECTS IN IT CAN BE CORRECTED.                                       **
********************************************************************************
********************************************************************************
** Example of an ADI setup with 32 ADIs each one holding a 16 bit value.
**
** In abcc_drv_cfg.h make sure that the following definitions are set to:
** ABCC_CFG_STRUCT_DATA_TYPE     ( FALSE )
** ABCC_CFG_ADI_GET_SET_CALLBACK ( TRUE )
********************************************************************************
********************************************************************************
*/

#include "appl_adi_config.h"

#if ( APPL_ACTIVE_ADI_SETUP == APPL_ADI_SETUP_SEPARATE_16 )

//#if( ABCC_CFG_STRUCT_DATA_TYPE || !ABCC_CFG_ADI_GET_SET_CALLBACK  )
//   #error ABCC_CFG_ADI_GET_SET_CALLBACK must be set to TRUE and ABCC_CFG_STRUCT_DATA_TYPE set to FALSE in order to run this example
//#endif

/*******************************************************************************
** Constants
********************************************************************************
*/

/*------------------------------------------------------------------------------
** Access descriptor for the ADIs
**------------------------------------------------------------------------------
*/
#define APPL_READ_MAP_READ_ACCESS_DESC ( ABP_APPD_DESCR_GET_ACCESS |           \
                                         ABP_APPD_DESCR_MAPPABLE_READ_PD )

#define APPL_READ_MAP_WRITE_ACCESS_DESC ( ABP_APPD_DESCR_GET_ACCESS |          \
                                          ABP_APPD_DESCR_SET_ACCESS |          \
                                          ABP_APPD_DESCR_MAPPABLE_READ_PD )

#define APPL_WRITE_MAP_READ_ACCESS_DESC ( ABP_APPD_DESCR_GET_ACCESS |          \
                                          ABP_APPD_DESCR_MAPPABLE_WRITE_PD )

#define APPL_NOT_MAP_READ_ACCESS_DESC ( ABP_APPD_DESCR_GET_ACCESS |            \
                                        ABP_APPD_DESCR_MAPPABLE_WRITE_PD )

#define APPL_NOT_MAP_WRITE_ACCESS_DESC ( ABP_APPD_DESCR_GET_ACCESS |           \
                                         ABP_APPD_DESCR_SET_ACCESS )


#define APPL_GET_INPUT_DATA     (PD_READ)
#define APPL_WRITE_OUTPUT_DATA  (PD_WRITE)

/*******************************************************************************
** Typedefs
********************************************************************************
*/

/*******************************************************************************
** Private Globals
********************************************************************************
*/
/*------------------------------------------------------------------------------
** Forward declarations
**------------------------------------------------------------------------------
*/
static void SetAdi10Value( const struct AD_AdiEntry* psAdiEntry, UINT8 bNumElements, UINT8 bStartIndex );
static void GetAdi11Value( const struct AD_AdiEntry* psAdiEntry, UINT8 bNumElements, UINT8 bStartIndex );

/*------------------------------------------------------------------------------
** Data holder for the ADI instances
**------------------------------------------------------------------------------
*/
//#define EXAMPLE_SEPERATE
#ifdef EXAMPLE_SEPERATE
#define APP_SEPERATE_ARRAY_SIZE 32
UINT16  appl_aiUint16_10[ APP_SEPERATE_ARRAY_SIZE ];
UINT16  appl_aiUint16_11[ APP_SEPERATE_ARRAY_SIZE ];
UINT16 appl_Uint16_12 = 0;
#else
typedef struct
{
    UINT16 OutputData_ui16;
    UINT8  OutputData_ui8;
} TestOutputDataType;
TestOutputDataType Appl_OutputData;

typedef struct
{
    UINT8  InputData_ui8;
    UINT16 InputData_ui16;
} TestInputDataType;
TestInputDataType Appl_InputData;
UINT16 appl_Uint16_12 = 0;

typedef struct
{
    UINT8  OutputData1_ui8;
//    UINT16 OutputData2_ui16;
//    UINT8  OutputData3_ui8;
//    UINT32 OutputData4_ui32;
} TestOutputViaStructType;
TestOutputViaStructType Appl_TestOutputViaStruct;

typedef struct
{
    UINT8  InputData1_ui8;
//    UINT16 InputData2_ui16;
//    UINT8  InputData3_ui8;
//    UINT32 InputData4_ui32;
} TestInputViaStructType;
TestInputViaStructType Appl_TestInputViaStruct;

static const AD_StructDataType Appl_OutputStruct[] =
{
   /* Index: 0 */  { "ABP_UINT8",  ABP_UINT8,  1, APPL_READ_MAP_WRITE_ACCESS_DESC, 0, {{&Appl_TestOutputViaStruct.OutputData1_ui8,  NULL }}},
//   /* Index: 1 */  { "ABP_UINT16", ABP_UINT16, 1, APPL_READ_MAP_WRITE_ACCESS_DESC, 0, {{&Appl_TestOutputViaStruct.OutputData2_ui16, NULL }}},
//   /* Index: 3 */  { "ABP_UINT8",  ABP_UINT8,  1, APPL_READ_MAP_WRITE_ACCESS_DESC, 0, {{&Appl_TestOutputViaStruct.OutputData3_ui8,  NULL }}},
//   /* Index: 4 */  { "ABP_UINT32", ABP_UINT32, 1, APPL_READ_MAP_WRITE_ACCESS_DESC, 0, {{&Appl_TestOutputViaStruct.OutputData4_ui32, NULL }}},
};

static const AD_StructDataType Appl_InputStruct[] =
{
   /* Index: 0 */  { "ABP_UINT8",  ABP_UINT8,  1, APPL_WRITE_MAP_READ_ACCESS_DESC, 0, {{&Appl_TestInputViaStruct.InputData1_ui8,  NULL }}},
//   /* Index: 1 */  { "ABP_UINT16", ABP_UINT16, 1, APPL_WRITE_MAP_READ_ACCESS_DESC, 0, {{&Appl_TestInputViaStruct.InputData2_ui16, NULL }}},
//   /* Index: 3 */  { "ABP_UINT8",  ABP_UINT8,  1, APPL_WRITE_MAP_READ_ACCESS_DESC, 0, {{&Appl_TestInputViaStruct.InputData3_ui8,  NULL }}},
//   /* Index: 4 */  { "ABP_UINT32", ABP_UINT32, 1, APPL_WRITE_MAP_READ_ACCESS_DESC, 0, {{&Appl_TestInputViaStruct.InputData4_ui32, NULL }}},
};

#endif
/*******************************************************************************
** Public Globals
********************************************************************************
*/

/*------------------------------------------------------------------------------
** 32 16-bit values individually
** See abcc_ad_if.h for a more detailed description.
**------------------------------------------------------------------------------
*/
/*-----------------------------------------------------------------------------------------------------------------------
** iInstance | pabName | bDataType | bNumOfElements | bDesc | pxValuePtr | pxValuePropPtr| pnGetAdiValue | pnSetAdiValue
**-----------------------------------------------------------------------------------------------------------------------
*/
#ifdef EXAMPLE_SEPERATE
const AD_AdiEntryType APPL_asAdiEntryList[] =
{
   { 10,   "ABP_UINT16_SET",        ABP_UINT16,   APP_SEPERATE_ARRAY_SIZE, APPL_READ_MAP_WRITE_ACCESS_DESC, { { appl_aiUint16_10 ,NULL } }, NULL, SetAdi10Value },
   { 11,   "ABP_UINT16_GET",        ABP_UINT16,   APP_SEPERATE_ARRAY_SIZE, APPL_WRITE_MAP_READ_ACCESS_DESC, { { appl_aiUint16_11 ,NULL } }, GetAdi11Value, NULL },
   { 12,   "ABP_UINT16_COUNTER",    ABP_UINT16,   1,  APPL_NOT_MAP_WRITE_ACCESS_DESC,  { { &appl_Uint16_12 ,NULL  } }, NULL, NULL         },
};
#else
const AD_AdiEntryType APPL_asAdiEntryList[] =
{
   {10,   "ABP_INPUT_D8",  ABP_UINT8,  1,   APPL_READ_MAP_WRITE_ACCESS_DESC, {{&Appl_InputData.InputData_ui8,  NULL}}, NULL},
   {11,   "ABP_OUTPUT_D8",  ABP_UINT8,  1,  APPL_WRITE_MAP_READ_ACCESS_DESC, {{&Appl_OutputData.OutputData_ui8,    NULL}}, NULL},
   {12,   "ABP_INPUT_D16", ABP_UINT16, 1,   APPL_READ_MAP_WRITE_ACCESS_DESC, {{&Appl_OutputData.OutputData_ui16, NULL}}, NULL},
   {13,   "ABP_OUTPUT_D16", ABP_UINT16, 1,   APPL_WRITE_MAP_READ_ACCESS_DESC, {{&Appl_InputData.InputData_ui16,   NULL}}, NULL},
   {14,   "Struct_SET",  ABP_UINT8,  1,   APPL_WRITE_MAP_READ_ACCESS_DESC, {{NULL,                             NULL}}, Appl_OutputStruct },
   {15,   "Struct_GET",  ABP_UINT8,  1,   APPL_READ_MAP_WRITE_ACCESS_DESC, {{NULL,                             NULL}}, Appl_InputStruct },
   {16,   "ABP_UINT16_COUNTER", ABP_UINT16, 1, APPL_NOT_MAP_WRITE_ACCESS_DESC,  {{ &appl_Uint16_12,            NULL}}, NULL},
};
#endif
/*
**------------------------------------------------------------------------------
** Map all adi:s in both directions
** See abcc_ad_if.h for a more detailed description.
**------------------------------------------------------------------------------
** 1. AD instance | 2. Direction | 3. Num elements | 4. Start index |
**------------------------------------------------------------------------------
*/
#ifdef EXAMPLE_SEPERATE
const AD_DefaultMapType APPL_asAdObjDefaultMap[] =
{
   { 10,  PD_READ,   AD_DEFAULT_MAP_ALL_ELEM, 0 },
   { 11,  PD_WRITE,  AD_DEFAULT_MAP_ALL_ELEM, 0 },
   { AD_DEFAULT_MAP_END_ENTRY }
};
#else


const AD_DefaultMapType APPL_asAdObjDefaultMap[] =
{
   { 10,  APPL_GET_INPUT_DATA,  AD_DEFAULT_MAP_ALL_ELEM, 0 },   /* Marked as output slot in Profinet master */
   { 11,  APPL_WRITE_OUTPUT_DATA, AD_DEFAULT_MAP_ALL_ELEM, 0 }, /* Marked as input slot in Profinet master */
   { 12,  APPL_GET_INPUT_DATA,  AD_DEFAULT_MAP_ALL_ELEM, 0 },   /* Marked as output slot in Profinet master */
   { 13,  APPL_WRITE_OUTPUT_DATA, AD_DEFAULT_MAP_ALL_ELEM, 0 }, /* Marked as input slot in Profinet master */
   { 14,  APPL_WRITE_OUTPUT_DATA, AD_DEFAULT_MAP_ALL_ELEM, 0 }, /* Marked as input slot in Profinet master */
   { 15,  APPL_GET_INPUT_DATA,  AD_DEFAULT_MAP_ALL_ELEM, 0 },   /* Marked as output slot in Profinet master */
   { AD_DEFAULT_MAP_END_ENTRY }
};
#endif

/*******************************************************************************
** Private Services
********************************************************************************
*/
#ifdef EXAMPLE_SEPERATE
/*------------------------------------------------------------------------------
** Callback of type ABCC_GetAdiValueFuncType. The function will be called when
** the network reads ADI #11. It will increment the value of ADI#12 every time
** this is done.
**
** ABCC_GetAdiValueFuncType is declared in abcc_ad_if.h
**------------------------------------------------------------------------------
*/
static void GetAdi11Value( const struct AD_AdiEntry* psAdiEntry, UINT8 bNumElements, UINT8 bStartIndex )
{
   appl_Uint16_12++;
}
/*------------------------------------------------------------------------------
** Callback of type ABCC_SetAdiValueFuncType. The function will be called when
** the network writes to ADI#10. It copies the changed values from ADI#10 to ADI#11.
**
** ABCC_SetAdiValueFuncType is declared in abcc_ad_if.h
**------------------------------------------------------------------------------
*/
static void SetAdi10Value( const struct AD_AdiEntry* psAdiEntry, UINT8 bNumElements, UINT8 bStartIndex )
{
   UINT8 index;
   for( index = bStartIndex ; index < bStartIndex+bNumElements ; index++ )
   {
      appl_aiUint16_11[ index ] = appl_aiUint16_10[ index ];
   }
}
#endif

/*******************************************************************************
** Public Services
********************************************************************************
*/
UINT16 APPL_GetNumAdi( void )
{
   return( sizeof( APPL_asAdiEntryList ) / sizeof( AD_AdiEntryType ) );
}

void APPL_CyclicalProcessing( void )
{
   /*
   ** This function is called when read and write data have been updated. It
   ** could for example be used for operations on the ADI data.
   ** Not used in this example.
   */
}

/*******************************************************************************
** Tasks
********************************************************************************
*/
#endif

